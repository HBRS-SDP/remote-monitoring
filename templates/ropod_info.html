{% extends "layout.html" %}
{% block body %}

<style>
.green_dot {
    height: 25px;
    width: 25px;
    background-color: rgb(0, 255, 0);
    border-radius: 50%;
    display: inline-block;
}
.red_dot {
    height: 25px;
    width: 25px;
    background-color: rgb(255, 0, 0);
    border-radius: 50%;
    display: inline-block;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="{{ url_for('static', filename='datatables/js/jquery.dataTables.js') }}" type="text/javascript"></script>

<script>
    var ropod_id = '';
    var ropod_status_timeout = null;

    $(document).ready(function() {
        $('#error_message_container').hide();
        $('#operation_indicator').show();
        $.ajax({
            url: SCRIPT_ROOT + '/get_ropod_status_ids',
            type: 'get',
            contentType: 'application/json',
            cache: false
        }).done(function(result) {
            $('#operation_indicator').hide();
            if (result.message != '')
            {
                $('#error_message_container').show();
                $('#error_message_container_content').html(result.message);
            }
        }).fail(function(jqXHR, status, error) {
            console.log(error);
            $('#error_message_container').show();
            $('#error_message_container_content').html('An unexpected error has occurred');
            $('#operation_indicator').hide();
        });

        setTimeout(execute_query, 5000);

        // ==================== get ropod ids =====================
        function execute_query()
        {
            var html_string = '';
            html_string += '<table id="ropods" width="100%" class="table table-striped table-bordered table-hover"><thead><th width="75%">Ropod</th><th width="5%">Status</th><th width="10%">Status time</th><th width="10%">Detailed status</th></thead><tbody>';
            var green_circle = '<span class="green_dot"></span>';
            var red_circle = '<span class="red_dot"></span>';

            $.ajax({
                url: SCRIPT_ROOT + '/get_status_of_all_ropods',
                type: 'get',
                contentType: 'application/json',
                cache: false
            }).done(function(result) {
                if (result.message != '')
                {
                    $('#error_message_container').show();
                    $('#error_message_container_content').html(result.message);
                    return;
                }

                $.each(result.status_list, function(ropod, ropod_status){
                    html_string += '<tr><td>' + ropod + '</td>';
                    if (ropod_status[0] == true)
                    {
                        html_string += '<td>' + green_circle +'</td>';
                    }
                    else if (ropod_status[0] == false)
                    {
                        html_string += '<td>' + red_circle +'</td>';
                    }
                    // adding the timestamp
                    html_string += '<td>' + ropod_status[1] +'</td>';
                    // adding the button
                    html_string += '<td><button id="' + ropod + '" value="' + ropod + '" class="btn btn-primary" type="button">Get detailed status</button></td></tr>';
                });

                html_string += '</tbody></table>';
                $('#overall_ropod_status_container').html('');
                $('#overall_ropod_status_container').html(html_string);
                $('#overall_ropod_status_container').prop('disabled', false);
            }).fail(function(jqXHR, status, error) {
                console.log(error);
                $('#error_message_container').show();
                $('#error_message_container_content').html('An unexpected error has occurred');
                $('#operation_indicator').hide();
            });

            setTimeout(execute_query, 5000);
        }

        function getRopodStatus()
        {
            if (ropod_id == '')
            {
                return;
            }

            var html_string = '';
            html_string += '<table id="ropods" width="100%" class="table table-striped table-bordered table-hover"><thead><th width="90%">Status of <b>' + ropod_id + '</b></th><th width="10%"><button id="hide_detailed_status" class="btn btn-primary" type="button">Hide detailed status</button></th></thead><tbody>';
            var green_circle = '<span class="green_dot"></span>';
            var red_circle = '<span class="red_dot"></span>';

            $.ajax({
                url: SCRIPT_ROOT + '/read_ropod_status',
                type: 'get',
                data: { ropod_id: ropod_id },
                contentType: 'application/json',
                cache: false
            }).done(function(result) {
                if (ropod_id == '')
                {
                    return;
                }

                if (result.message != '')
                {
                    $('#error_message_container').show();
                    $('#error_message_container_content').html(result.message);
                    return;
                }

                var status = result.ropod_status.payload.status;
                $.each(status, function(category, variables) {
                    html_string += '<tr><td colspan="2"><h3>' + category + '</h3></td></tr>';
                    $.each(status[category], function(variable, value) {
                        var length = Object.keys(status[category][variable]).length;
                        var is_list_of_variables = Object.keys(status[category][variable]).length > 0;
                        if (is_list_of_variables)
                        {
                            $.each(status[category][variable], function(list_item, item_value) {
                                if (typeof(item_value) == 'number')
                                {
                                    html_string += '<tr><td>' + list_item + '</td><td>' + item_value +'</td></tr>';
                                }
                                else if (item_value == true)
                                {
                                    html_string += '<tr><td>' + list_item + '</td><td>' + green_circle +'</td></tr>';
                                }
                                else
                                {
                                    html_string += '<tr><td>' + list_item + '</td><td>' + red_circle +'</td></tr>';
                                }
                            });
                        }
                        else
                        {
                            if (typeof(value) == 'number')
                            {
                                html_string += '<tr><td>' + variable + '</td><td>' + value +'</td></tr>';
                            }
                            else if (value == true)
                            {
                                html_string += '<tr><td>' + variable + '</td><td>' + green_circle +'</td></tr>';
                            }
                            else
                            {
                                html_string += '<tr><td>' + variable + '</td><td>' + red_circle +'</td></tr>';
                            }
                        }
                    });
                });

                html_string += '</tbody></table></div>';
                $('#status_container').html('');
                $('#status_container').html(html_string);
                $('#status_container').prop('disabled', false);
            }).fail(function(jqXHR, status, error) {
                console.log(error);
                $('#error_message_container').show();
                $('#error_message_container_content').html('An unexpected error has occurred');
            });

            if (ropod_id != '')
            {
                if (ropod_status_timeout)
                {
                    clearTimeout(ropod_status_timeout);
                    ropod_status_timeout = null;
                }
                ropod_status_timeout = setTimeout(getRopodStatus, 5000);
            }
        }

        $('.ropod_table').on('click', 'button', function() {
            ropod_id = $(this).val();
            getRopodStatus();
        });

        $(document).on('click', 'button#hide_detailed_status', function() {
            ropod_id = '';
            clearTimeout(ropod_status_timeout);
            ropod_status_timeout = null;
            $('#status_container').html('');
        });
    });
</script>

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Ropod info</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-1">
        <div id="operation_indicator" class="indicator"></div>
    </div>
</div>

<div id="error_message_container" class="alert alert-danger alert-dismissible">
    <a href="#" class="close" onclick="$('.alert').hide()">&times;</a>
    <p id="error_message_container_content"></p>
</div>

<div id="overall_ropod_status_container" class="ropod_table" disabled="disabled">
    <div class="panel panel-default">
    </div>
</div>

<div id="status_container" disabled="disabled">
    <div class="panel panel-default">
    </div>
</div>

{% endblock %}
