{% extends "layout.html" %}
{% block body %}

<style>
.green_dot {
    height: 15px;
    width: 15px;
    background-color: rgb(0, 255, 0);
    border-radius: 50%;
    display: inline-block;
}
.red_dot {
    height: 15px;
    width: 15px;
    background-color: rgb(255, 0, 0);
    border-radius: 50%;
    display: inline-block;
}
.grey_dot {
    height: 15px;
    width: 15px;
    background-color: rgb(128, 128, 128);
    border-radius: 50%;
    display: inline-block;
}
.toggle {
    display: none;
}
</style>

<script src="{{ url_for('static', filename='datatables/js/jquery.dataTables.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='jquery-1.11.2.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='socket.io.slim.js') }}" type="text/javascript"></script>

<script>
    // currently selected ropod. Full status of this ropod
    // is to be shown
    var current_ropod_id = '';

    $(document).ready(function() {
        $('#error_message_container').hide();
        $('#operation_indicator').hide();
        $('#status_container').hide();

        // click on 'Detailed status' button
        $('.ropod_table').on('click', 'button', function() {
            current_ropod_id = $(this).val();
            // clear the current table
            $("#detailed_component_monitors tbody").html('');
            var table = document.getElementById('detailed_component_monitors');
            var title = table.getElementsByTagName('th')[0];
            title.innerHTML = '';
        });
        // click on 'Hide detailed status' button
        $(document).on('click', 'button#hide_detailed_status', function() {
            current_ropod_id = '';
            $('#detailed_component_monitors tbody').html('');
            var table = document.getElementById('detailed_component_monitors');
            var title = table.getElementsByTagName('th')[0];
            title.innerHTML = '';
            $('#status_container').hide();
        });

        // expand all component monitor modes
        $(document).on('click', 'button#expand_all', function() {
            $('.monitor_modes').show();
        });
        // collapse all component monitor modes
        $(document).on('click', 'button#collapse_all', function() {
            $('.monitor_modes').hide();
        });

    });

    var socket = io.connect('http://' + document.domain + ':' + location.port + '/ropod_status');
    // receive list of deployed ropod ids
    socket.on('deployed_ropods', function(msg) {
        $("#ropod_list tr:not(:first)").remove()
        var t = document.getElementById('ropod_list');
        data = JSON.parse(msg.data)
        for (var i = 0; i < data.length; i++)
        {
            var r = t.insertRow(-1);
            var c = r.insertCell(-1);
            c.innerHTML = data[i];
            r.insertCell(-1);
            r.insertCell(-1);
            r.insertCell(-1);
            var button = r.insertCell(-1);
            button.innerHTML = '<td><button id="' + data[i] + '" value="' + data[i] + '" class="btn btn-primary" type="button">Get detailed status</button></td>';
        }
    });
    // receive list of ropods that are currently online
    socket.on('zyre_peers', function(msg) {
        var t = document.getElementById('ropod_list');
        data = JSON.parse(msg.data);
        for (var i = 1, row; row = t.rows[i]; i++)
        {
            // if current row exists in zyre_peers
            // set online true, status unknown (if no status received)
            if (data.indexOf(row.cells[0].innerHTML) > -1)
            {
                row.cells[1].innerHTML = '<span class="green_dot"></span>'
                row.cells[1].style.textAlign = 'center';
                row.cells[1].style.verticalAlign = 'middle';

                if (row.cells[2].innerHTML == '')
                {
                    row.cells[2].innerHTML = '<span class="grey_dot"></span>'
                    row.cells[2].style.textAlign = 'center';
                    row.cells[2].style.verticalAlign = 'middle';
                }
            }
            // set online false, and status unknown
            else
            {
                row.cells[1].innerHTML = '<span class="red_dot"></span>'
                row.cells[1].style.textAlign = 'center';
                row.cells[1].style.verticalAlign = 'middle';

                row.cells[2].innerHTML = '<span class="grey_dot"></span>'
                row.cells[2].style.textAlign = 'center';
                row.cells[2].style.verticalAlign = 'middle';

                if (data.indexOf(current_ropod_id) < 0)
                {
                    $('#detailed_component_monitors tbody').html('');
                    $('#status_container').hide();
                }
            }
        }
    });

    function toggle_monitor(component_monitor_name_label){
        monitor_name = component_monitor_name_label;
        console.log($('#'+monitor_name).parents().next('.monitor_modes'));
        $('#'+monitor_name).parents().next('.monitor_modes').toggle();
    }
    // receive status message (for a single ropod)
    socket.on('status_msg', function(msg) {
        var jmsg = JSON.parse(msg.data);
        var ropod_id = jmsg.payload.ropodId;
        // only update the full table if it's the current ropod_id
        if (ropod_id == current_ropod_id)
        {
            var tbody = $("#detailed_component_monitors tbody");
            // table has not been constructed yet; so construct it with correct
            // component monitor and mode names
            if (tbody.children().length == 0)
            {
                var table = document.getElementById('detailed_component_monitors');
                var title = table.getElementsByTagName('th')[0];
                title.innerHTML = 'Status of <b>' + ropod_id + '</b>'
                var monitors = jmsg.payload.monitors;
                for (var monitor in monitors)
                {
                    component_monitor_name = monitors[monitor].component;
                    comp_tbody = document.createElement('tbody');
                    comp_tbody.className = 'component_monitor';
                    header_row = comp_tbody.insertRow(-1);
                    header_row.style.backgroundColor = "rgba(0,0,0,.075)";
                    cell = header_row.insertCell(-1);
                    cell_id = component_monitor_name.split(' ').join('_') + '_label'
                    cell_html = '<label for="' + cell_id + '" style="display:block">' + component_monitor_name + '</label>';
                    cell_html += '<input type="checkbox" name="' + component_monitor_name + '" id="' + cell_id + '" class="toggle" onclick="toggle_monitor(this.id)" />';
                    cell.innerHTML = cell_html;

                    overall_status_cell = header_row.insertCell(-1);
                    overall_status_cell.id = component_monitor_name;
                    overall_status_cell.style.textAlign = 'center';
                    overall_status_cell.style.verticalAlign = 'middle';
                    header_row.insertCell(-1);
                    header_row.insertCell(-1);

                    table.appendChild(comp_tbody);

                    modes_tbody = document.createElement('tbody');
                    modes_tbody.className = 'monitor_modes';
                    modes_tbody.style.display = "none";
                    var modes = monitors[monitor].modes;
                    for (var mode in modes)
                    {
                        var modeDescription = modes[mode].monitorDescription;
                        mode_row = modes_tbody.insertRow(-1);
                        mode_row.style.backgroundColor = "#fdfdfe";
                        mode_row_c1 = mode_row.insertCell(-1);
                        mode_row_c1.innerText = modeDescription;
                        status_cell = mode_row.insertCell(-1);
                        status_cell.id = component_monitor_name + modeDescription;
                        status_cell.style.textAlign = 'center';
                        status_cell.style.verticalAlign = 'middle';
                        mode_row.insertCell(-1);
                        mode_row.insertCell(-1);
                    }
                    table.appendChild(modes_tbody);
                }
                $('#status_container').show();
            }
            // display the status of each monitor and mode
            var monitors = jmsg.payload.monitors;
            for (var monitor in monitors)
            {
                component_monitor_name = monitors[monitor].component;
                var modes = monitors[monitor].modes;
                var overall_status = true;

                for (var mode in modes)
                {
                    var healthStatus = modes[mode].healthStatus;
                    var stat = healthStatus['status'];
                    var modeDescription = modes[mode].monitorDescription;
                    var id = component_monitor_name + modeDescription;
                    status_cell = document.getElementById(id);
                    if (stat == false)
                    {
                        status_cell.innerHTML = '<span class="red_dot" title=' + JSON.stringify(healthStatus) + '></span>';
                        overall_status = false;
                    }
                    else
                    {
                        status_cell.innerHTML = '<span class="green_dot" title=' + JSON.stringify(healthStatus) + '></span>';
                    }
                }
                overall_status_cell = document.getElementById(component_monitor_name);
                if (overall_status == false)
                {
                    overall_status_cell.innerHTML = '<span class="red_dot"></span>';
                }
                else
                {
                    overall_status_cell.innerHTML = '<span class="green_dot"></span>';
                }

            }
        }
        // function as seen on stackoverflow.com by Ponmudi VN
        // (https://stackoverflow.com/questions/6384421/check-whether-a-value-exists-in-json-object)
        // check if value is contained in any key of the json object
        function _isContains(json, value) {
            let contains = false;
            Object.keys(json).some(key => {
                contains = typeof json[key] === 'object' ? _isContains(json[key], value) : json[key] === value;
                 return contains;
            });
            return contains;
        }
        // check if any status is false
        var overall_ropod_status = !(_isContains(jmsg.payload.monitors, false));
        var t = document.getElementById('ropod_list');
        for (var i = 1, row; row = t.rows[i]; i++)
        {
            if (row.cells[0].innerText == ropod_id)
            {
                if (overall_ropod_status == false)
                {
                    row.cells[2].innerHTML = '<span class="red_dot"></span>'
                    row.cells[2].style.textAlign = 'center';
                    row.cells[2].style.verticalAlign = 'middle';
                }
                else
                {
                    row.cells[2].innerHTML = '<span class="green_dot"></span>'
                    row.cells[2].style.textAlign = 'center';
                    row.cells[2].style.verticalAlign = 'middle';
                }
                row.cells[3].innerText = jmsg.header.timestamp;
            }
        }
    });

</script>

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Ropod info</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-1">
        <div id="operation_indicator" class="indicator"></div>
    </div>
</div>

<div id="error_message_container" class="alert alert-danger alert-dismissible">
    <a href="#" class="close" onclick="$('.alert').hide()">&times;</a>
    <p id="error_message_container_content"></p>
</div>

<div id="overall_ropod_status_container" class="ropod_table" disabled="disabled">
    <table id="ropod_list" width="100%" class="table table-striped table-bordered table-hover">
        <thead>
            <th width="70%">Ropod</th>
            <th width="5%">Online</th>
            <th width="5%">Status</th>
            <th width="10%">Status time</th>
            <th width="10%">Detailed status</th>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div class="panel panel-default">
    </div>
</div>

<div id="status_container" disabled="disabled">
    <table id="detailed_component_monitors" width="100%" class="table table-bordered">
        <thead>
            <th width="70%"></th>
            <th width="10%"><button id="expand_all" class="btn btn-primary" type="button">Expand all</button></th>
            <th width="10%"><button id="collapse_all" class="btn btn-primary" type="button">Collapse all</button></th>
            <th width="10%"><button id="hide_detailed_status" class="btn btn-primary" type="button">Hide detailed status</button></th>
        </thead>
        <tbody>
        </tbody>
    <div class="panel panel-default">
    </div>
</div>

{% endblock %}
